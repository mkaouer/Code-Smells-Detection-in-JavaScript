--- ../src_base/minecraft_server/net/minecraft/src/NetLoginHandler.java	0000-00-00 00:00:00.000000000 -0000
+++ ../src_work/minecraft_server/net/minecraft/src/NetLoginHandler.java	0000-00-00 00:00:00.000000000 -0000
@@ -1,10 +1,15 @@
 package net.minecraft.src;
 
 import java.io.IOException;
+import java.io.UnsupportedEncodingException;
 import java.net.Socket;
 import java.util.*;
 import java.util.logging.Logger;
 import net.minecraft.server.MinecraftServer;
+import net.minecraft.src.forge.ForgeHooks;
+import net.minecraft.src.forge.ForgeHooksServer;
+import net.minecraft.src.forge.MessageManager;
+import net.minecraft.src.forge.packets.ForgePacket;
 
 public class NetLoginHandler extends NetHandler
 {
@@ -29,6 +34,7 @@
         mcServer = minecraftserver;
         netManager = new NetworkManager(socket, s, this);
         netManager.chunkDataSendCounter = 0;
+        ForgeHooks.onConnect(netManager);
     }
 
     public void tryLogin()
@@ -129,7 +135,39 @@
             }
 
             entityplayermp.func_20057_k();
-            ModLoaderMp.HandleAllLogins(entityplayermp);
+            
+            if (packet1login.serverMode == ForgePacket.FORGE_ID)
+            {
+                //Pretty hackish place to put it, but it needs to go somewhere
+                ForgeHooksServer.init();
+                //pkt.mapSeed = ForgeHooks.buildVersion;
+                ForgeHooks.onLogin(netManager, packet1login);                
+
+                String[] channels = MessageManager.getInstance().getRegisteredChannels(netManager);
+                StringBuilder tmp = new StringBuilder();
+                tmp.append("Forge");
+                for(String channel : channels)
+                {
+                    tmp.append("\0");
+                    tmp.append(channel);
+                }
+                Packet250CustomPayload pkt = new Packet250CustomPayload(); 
+                pkt.channel = "REGISTER";
+                try {
+                    pkt.data = tmp.toString().getBytes("UTF8");
+                } catch (UnsupportedEncodingException e) {
+                    e.printStackTrace();
+                }
+                pkt.length = pkt.data.length;
+                netserverhandler.sendPacket(pkt);
+                ForgeHooksServer.sendModListRequest(netManager);                
+                ModLoaderMp.HandleAllLogins(entityplayermp);
+            }
+            else
+            {
+                netserverhandler.kickPlayer("This server requires you to have Minecraft Forge installed.");
+            }
+                
         }
         finishedProcessing = true;
     }
