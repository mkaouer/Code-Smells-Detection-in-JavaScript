<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">

<title>C:/release/quickfix/src/C++/FileStore.cpp Source File</title>

<link href="quickfix.css" rel="stylesheet" type="text/css">

<table cellspacing="0" cellpadding="0" border="0">

  <tr>

   <td><img src="images/outsideTopLeft.gif"></td>

   <td width="100%" class="outsideTop">&nbsp;</td>

   <td><img src="images/outsideTopRight.gif"></td>

  </tr>

  <tr>

   <td class="outsideLeft">&nbsp;</td>

   <td>

	<img src="images/QuickFIX.jpg" align="middle" border=0>

	&nbsp;&nbsp;

	<a href="index.html">Index</a>&nbsp;

	<a href="files.html">Source Files</a>&nbsp;

	<a href="annotated.html">Annotated Class List</a>&nbsp;

	<a href="classes.html">Alphabetical Class List</a>&nbsp;

	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;

	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;

   </td>

   <td class="outsideRight">&nbsp;</td>

  </tr>

  <tr>

   <td><img src="images/outsideBottomLeft.gif"></td>

   <td width=100% class="outsideBottom">&nbsp;</td>

   <td><img src="images/outsideBottomRight.gif"></td>

  </tr>

</table>

</head><body bgcolor="#ffffff">

<!-- Generated by Doxygen 1.2.17 -->
<h1>C:/release/quickfix/src/C++/FileStore.cpp</h1><a href="_file_store_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/* ====================================================================</span>
00002 <span class="comment">* The QuickFIX Software License, Version 1.0</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 2001 ThoughtWorks, Inc.  All rights</span>
00005 <span class="comment">* reserved.</span>
00006 <span class="comment">*</span>
00007 <span class="comment">* Redistribution and use in source and binary forms, with or without</span>
00008 <span class="comment">* modification, are permitted provided that the following conditions</span>
00009 <span class="comment">* are met:</span>
00010 <span class="comment">*</span>
00011 <span class="comment">* 1. Redistributions of source code must retain the above copyright</span>
00012 <span class="comment">*    notice, this list of conditions and the following disclaimer.</span>
00013 <span class="comment">*</span>
00014 <span class="comment">* 2. Redistributions in binary form must reproduce the above copyright</span>
00015 <span class="comment">*    notice, this list of conditions and the following disclaimer in</span>
00016 <span class="comment">*    the documentation and/or other materials provided with the</span>
00017 <span class="comment">*    distribution.</span>
00018 <span class="comment">*</span>
00019 <span class="comment">* 3. The end-user documentation included with the redistribution,</span>
00020 <span class="comment">*    if any, must include the following acknowledgment:</span>
00021 <span class="comment">*       "This product includes software developed by</span>
00022 <span class="comment">*        ThoughtWorks, Inc. (http://www.thoughtworks.com/)."</span>
00023 <span class="comment">*    Alternately, this acknowledgment may appear in the software itself,</span>
00024 <span class="comment">*    if and wherever such third-party acknowledgments normally appear.</span>
00025 <span class="comment">*</span>
00026 <span class="comment">* 4. The names "QuickFIX" and "ThoughtWorks, Inc." must</span>
00027 <span class="comment">*    not be used to endorse or promote products derived from this</span>
00028 <span class="comment">*    software without prior written permission. For written</span>
00029 <span class="comment">*    permission, please contact quickfix-users@lists.sourceforge.net.</span>
00030 <span class="comment">*</span>
00031 <span class="comment">* 5. Products derived from this software may not be called "QuickFIX",</span>
00032 <span class="comment">*    nor may "QuickFIX" appear in their name, without prior written</span>
00033 <span class="comment">*    permission of ThoughtWorks, Inc.</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED</span>
00036 <span class="comment">* WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</span>
00037 <span class="comment">* OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
00038 <span class="comment">* DISCLAIMED.  IN NO EVENT SHALL THOUGHTWORKS INC OR</span>
00039 <span class="comment">* ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
00040 <span class="comment">* SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
00041 <span class="comment">* LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</span>
00042 <span class="comment">* USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
00043 <span class="comment">* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
00044 <span class="comment">* OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span>
00045 <span class="comment">* OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00046 <span class="comment">* SUCH DAMAGE.</span>
00047 <span class="comment">* ====================================================================</span>
00048 <span class="comment">*/</span>
00049 
00050 <span class="preprocessor">#ifdef _MSC_VER</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00052 <span class="preprocessor">#else</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00054 <span class="preprocessor">#endif</span>
00055 <span class="preprocessor"></span>
00056 <span class="preprocessor">#include "<a class="code" href="_file_store_8h.html">FileStore.h</a>"</span>
00057 <span class="preprocessor">#include "<a class="code" href="_session_8h.html">Session.h</a>"</span>
00058 <span class="preprocessor">#include "<a class="code" href="_parser_8h.html">Parser.h</a>"</span>
00059 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00060 <span class="preprocessor">#include &lt;fstream&gt;</span>
00061 
00062 <span class="keyword">namespace </span>FIX
00063 {
<a name="l00064"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a0">00064</a> FileStore::FileStore( std::string path, <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a>&amp; s )
00065     : m_msgFile( 0 ), m_headerFile( 0 ), m_seqNumsFile( 0 ), m_sessionFile( 0 )
00066 {
00067   <a class="code" href="namespace_f_i_x.html#a862">file_mkdir</a>( path.c_str(), 0700 );
00068 
00069   <span class="keywordflow">if</span> ( path.empty() ) path = <span class="stringliteral">"."</span>;
00070   <span class="keyword">const</span> std::string&amp; begin =
00071     s.getBeginString().getString();
00072   <span class="keyword">const</span> std::string&amp; sender =
00073     s.getSenderCompID().getString();
00074   <span class="keyword">const</span> std::string&amp; target =
00075     s.getTargetCompID().getString();
00076 
00077   std::string prefix = path + <span class="stringliteral">"/"</span> + begin + <span class="stringliteral">"-"</span> + sender + <span class="stringliteral">"-"</span> + target + <span class="stringliteral">"."</span>;
00078 
00079   <a class="code" href="class_f_i_x_1_1_file_store.html#o2">m_msgFileName</a> = prefix + <span class="stringliteral">"body"</span>;
00080   <a class="code" href="class_f_i_x_1_1_file_store.html#o3">m_headerFileName</a> = prefix + <span class="stringliteral">"header"</span>;
00081   <a class="code" href="class_f_i_x_1_1_file_store.html#o4">m_seqNumFileName</a> = prefix + <span class="stringliteral">"seqnums"</span>;
00082   <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a> = prefix + <span class="stringliteral">"session"</span>;
00083 
00084   <span class="keywordflow">try</span>
00085   {
00086     <a class="code" href="class_f_i_x_1_1_file_store.html#c0">open</a>( <span class="keyword">false</span> );
00087   }
00088   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> &amp; e )
00089   {
00090     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( e.what() );
00091   }
00092 }
00093 
<a name="l00094"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a1">00094</a> FileStore::~FileStore()
00095 {
00096   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> );
00097   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> );
00098   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> );
00099   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> );
00100 }
00101 
<a name="l00102"></a><a class="code" href="class_f_i_x_1_1_file_store.html#c0">00102</a> <span class="keywordtype">void</span> FileStore::open( <span class="keywordtype">bool</span> deleteFile )
00103 {
00104   <span class="keywordflow">if</span> ( m_msgFile ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> );
00105   <span class="keywordflow">if</span> ( m_headerFile ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> );
00106   <span class="keywordflow">if</span> ( m_seqNumsFile ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> );
00107   <span class="keywordflow">if</span> ( m_sessionFile ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> );
00108 
00109   <span class="keywordflow">if</span> ( deleteFile )
00110   {
00111     <a class="code" href="namespace_f_i_x.html#a863">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#o2">m_msgFileName</a>.c_str() );
00112     <a class="code" href="namespace_f_i_x.html#a863">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#o3">m_headerFileName</a>.c_str() );
00113     <a class="code" href="namespace_f_i_x.html#a863">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#o4">m_seqNumFileName</a>.c_str() );
00114     <a class="code" href="namespace_f_i_x.html#a863">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a>.c_str() );
00115   }
00116 
00117   <a class="code" href="class_f_i_x_1_1_file_store.html#c1">populateCache</a>();
00118 
00119   <a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o2">m_msgFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00120   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o2">m_msgFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00121   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o6">m_msgFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open messages file"</span> );
00122 
00123   <a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o3">m_headerFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00124   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o3">m_headerFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00125   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o7">m_headerFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open header file"</span> );
00126 
00127   <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o4">m_seqNumFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00128   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o4">m_seqNumFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00129   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open seqnums file"</span> );
00130 
00131   <span class="keywordtype">bool</span> setCreationTime = <span class="keyword">false</span>;
00132   <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r"</span> );
00133   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> ) setCreationTime = <span class="keyword">true</span>;
00134   <span class="keywordflow">else</span> fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> );
00135 
00136   <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00137   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00138   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open session file"</span> );
00139   <span class="keywordflow">if</span> ( setCreationTime ) <a class="code" href="class_f_i_x_1_1_file_store.html#c4">setSession</a>();
00140 
00141   <a class="code" href="class_f_i_x_1_1_file_store.html#a7">setNextSenderMsgSeqNum</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#a5">getNextSenderMsgSeqNum</a>() );
00142   <a class="code" href="class_f_i_x_1_1_file_store.html#a8">setNextTargetMsgSeqNum</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#a6">getNextTargetMsgSeqNum</a>() );
00143 }
00144 
<a name="l00145"></a><a class="code" href="class_f_i_x_1_1_file_store.html#c1">00145</a> <span class="keywordtype">void</span> FileStore::populateCache()
00146 {
00147   std::string msg;
00148   <a class="code" href="class_f_i_x_1_1_message.html">Message</a> message;
00149 
00150   FILE* headerFile;
00151   headerFile = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o3">m_headerFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00152   <span class="keywordflow">if</span> ( headerFile )
00153   {
00154     <span class="keywordtype">int</span> num, offset, size;
00155     <span class="keywordflow">while</span> ( fscanf( headerFile, <span class="stringliteral">"%d,%d,%d "</span>, &amp;num, &amp;offset, &amp;size ) == 3 )
00156       <a class="code" href="class_f_i_x_1_1_file_store.html#o1">m_offsets</a>[ num ] = std::make_pair( offset, size );
00157     fclose( headerFile );
00158   }
00159 
00160   FILE* seqNumFile;
00161   seqNumFile = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o4">m_seqNumFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00162   <span class="keywordflow">if</span> ( seqNumFile )
00163   {
00164     <span class="keywordtype">int</span> sender, target;
00165     <span class="keywordflow">if</span> ( fscanf( seqNumFile, <span class="stringliteral">"%d : %d"</span>, &amp;sender, &amp;target ) == 2 )
00166     {
00167       <a class="code" href="class_f_i_x_1_1_file_store.html#o0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a6">setNextSenderMsgSeqNum</a>( sender );
00168       <a class="code" href="class_f_i_x_1_1_file_store.html#o0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a7">setNextTargetMsgSeqNum</a>( target );
00169     }
00170     fclose( seqNumFile );
00171   }
00172 
00173   FILE* sessionFile;
00174   sessionFile = fopen( <a class="code" href="class_f_i_x_1_1_file_store.html#o5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00175   <span class="keywordflow">if</span> ( sessionFile )
00176   {
00177     <span class="keywordtype">char</span> time[ 20 ];
00178     <span class="keywordflow">if</span> ( fscanf( sessionFile, <span class="stringliteral">"%s"</span>, time ) == 1 )
00179     {
00180       <a class="code" href="class_f_i_x_1_1_file_store.html#o0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a10">setCreationTime</a>( UtcTimeStampConvertor::convert( time ) );
00181     }
00182     fclose( sessionFile );
00183   }
00184 }
00185 
<a name="l00186"></a><a class="code" href="class_f_i_x_1_1_file_store_factory.html#a2">00186</a> <a class="code" href="class_f_i_x_1_1_message_store.html">MessageStore</a>* FileStoreFactory::create( <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a>&amp; s )
00187 {
00188   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_file_store_factory.html#o0">m_path</a>.size() ) <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_f_i_x_1_1_file_store.html">FileStore</a>( <a class="code" href="class_f_i_x_1_1_file_store_factory.html#o0">m_path</a>, s );
00189 
00190   std::string path;
00191   <a class="code" href="class_f_i_x_1_1_dictionary.html">Dictionary</a> settings = <a class="code" href="class_f_i_x_1_1_file_store_factory.html#o1">m_settings</a>.<a class="code" href="class_f_i_x_1_1_session_settings.html#a3">get</a>( s );
00192   path = settings.<a class="code" href="class_f_i_x_1_1_dictionary.html#a5">getString</a>( FILE_STORE_PATH );
00193   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_f_i_x_1_1_file_store.html">FileStore</a>( path, s );
00194 }
00195 
<a name="l00196"></a><a class="code" href="class_f_i_x_1_1_file_store_factory.html#a3">00196</a> <span class="keywordtype">void</span> FileStoreFactory::destroy( <a class="code" href="class_f_i_x_1_1_message_store.html">MessageStore</a>* pStore )
00197 {
00198   <span class="keyword">delete</span> pStore;
00199 }
00200 
<a name="l00201"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a2">00201</a> <span class="keywordtype">bool</span> FileStore::set( <span class="keywordtype">int</span> msgSeqNum, <span class="keyword">const</span> std::string&amp; msg )
00202 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00203 {
00204   <span class="keywordflow">if</span> ( fseek( m_msgFile, 0, SEEK_END ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00205   <span class="keywordflow">if</span> ( fseek( m_headerFile, 0, SEEK_END ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00206 
00207   <span class="keywordtype">int</span> offset = ftell( m_msgFile );
00208   <span class="keywordflow">if</span> ( offset &lt; 0 ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00209   <span class="keywordtype">int</span> size = msg.size();
00210 
00211   <span class="keywordflow">if</span> ( fprintf( m_headerFile, <span class="stringliteral">"%d,%d,%d "</span>, msgSeqNum, offset, size ) &lt; 0 )
00212     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00213   m_offsets[ msgSeqNum ] = std::make_pair( offset, size );
00214   fwrite( msg.c_str(), <span class="keyword">sizeof</span>( char ), msg.size(), m_msgFile );
00215   <span class="keywordflow">if</span> ( ferror( m_msgFile ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00216   <span class="keywordflow">if</span> ( fflush( m_msgFile ) == EOF ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00217   <span class="keywordflow">if</span> ( fflush( m_headerFile ) == EOF ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00218   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00219 }
00220 
<a name="l00221"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a3">00221</a> <span class="keywordtype">bool</span> FileStore::get( <span class="keywordtype">int</span> msgSeqNum, std::string&amp; msg ) <span class="keyword">const</span>
00222 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00223 {
00224   NumToOffset::const_iterator find = m_offsets.find( msgSeqNum );
00225   <span class="keywordflow">if</span> ( find == m_offsets.end() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00226   <span class="keyword">const</span> OffsetSize&amp; offset = find-&gt;second;
00227   <span class="keywordflow">if</span> ( fseek( m_msgFile, offset.first, SEEK_SET ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00228   <span class="keywordtype">char</span>* buffer = <span class="keyword">new</span> <span class="keywordtype">char</span>[ offset.second + 1 ];
00229   fread( buffer, <span class="keyword">sizeof</span>( <span class="keywordtype">char</span> ), offset.second, m_msgFile );
00230   <span class="keywordflow">if</span> ( ferror( m_msgFile ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00231   buffer[ offset.second ] = 0;
00232   msg = buffer;
00233   <span class="keyword">delete</span> [] buffer;
00234   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00235 }
00236 
<a name="l00237"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a4">00237</a> <span class="keywordtype">void</span> FileStore::get( <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end,
00238                      std::vector &lt; std::string &gt; &amp; result ) <span class="keyword">const</span>
00239 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00240 {
00241   result.clear();
00242   std::string msg;
00243   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = begin; i &lt;= end; ++i )
00244   {
00245     <span class="keywordflow">if</span> ( get( i, msg ) )
00246       result.push_back( msg );
00247   }
00248 }
00249 
<a name="l00250"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a5">00250</a> <span class="keywordtype">int</span> FileStore::getNextSenderMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00251 {
00252   <span class="keywordflow">return</span> m_cache.getNextSenderMsgSeqNum();
00253 }
00254 
<a name="l00255"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a6">00255</a> <span class="keywordtype">int</span> FileStore::getNextTargetMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00256 {
00257   <span class="keywordflow">return</span> m_cache.getNextTargetMsgSeqNum();
00258 }
00259 
<a name="l00260"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a7">00260</a> <span class="keywordtype">void</span> FileStore::setNextSenderMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00261 {
00262   m_cache.setNextSenderMsgSeqNum( value );
00263   setSeqNum();
00264 }
00265 
<a name="l00266"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a8">00266</a> <span class="keywordtype">void</span> FileStore::setNextTargetMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00267 {
00268   m_cache.setNextTargetMsgSeqNum( value );
00269   setSeqNum();
00270 }
00271 
<a name="l00272"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a9">00272</a> <span class="keywordtype">void</span> FileStore::incrNextSenderMsgSeqNum() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00273 {
00274   m_cache.incrNextSenderMsgSeqNum();
00275   setSeqNum();
00276 }
00277 
<a name="l00278"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a10">00278</a> <span class="keywordtype">void</span> FileStore::incrNextTargetMsgSeqNum() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00279 {
00280   m_cache.incrNextTargetMsgSeqNum();
00281   setSeqNum();
00282 }
00283 
<a name="l00284"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a11">00284</a> <a class="code" href="class_f_i_x_1_1_utc_time_stamp.html">UtcTimeStamp</a> FileStore::getCreationTime() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00285 {
00286   <span class="keywordflow">return</span> m_cache.getCreationTime();
00287 }
00288 
<a name="l00289"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a12">00289</a> <span class="keywordtype">void</span> FileStore::reset() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>&amp; )
00290 {
00291   m_cache.reset();
00292   open( <span class="keyword">true</span> );
00293   setSession();
00294 }
00295 
<a name="l00296"></a><a class="code" href="class_f_i_x_1_1_file_store.html#c3">00296</a> <span class="keywordtype">void</span> FileStore::setSeqNum()
00297 {
00298   rewind( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> );
00299   fprintf( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a>, <span class="stringliteral">"%d : %d"</span>,
00300            <a class="code" href="class_f_i_x_1_1_file_store.html#a5">getNextSenderMsgSeqNum</a>(), <a class="code" href="class_f_i_x_1_1_file_store.html#a6">getNextTargetMsgSeqNum</a>() );
00301   <span class="keywordflow">if</span> ( ferror( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00302   <span class="keywordflow">if</span> ( fflush( <a class="code" href="class_f_i_x_1_1_file_store.html#o8">m_seqNumsFile</a> ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00303 }
00304 
<a name="l00305"></a><a class="code" href="class_f_i_x_1_1_file_store.html#c4">00305</a> <span class="keywordtype">void</span> FileStore::setSession()
00306 {
00307   rewind( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> );
00308   fprintf( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a>, <span class="stringliteral">"%s"</span>,
00309            UtcTimeStampConvertor::convert( <a class="code" href="class_f_i_x_1_1_file_store.html#o0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a11">getCreationTime</a>() ).c_str() );
00310   <span class="keywordflow">if</span> ( ferror( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00311   <span class="keywordflow">if</span> ( fflush( <a class="code" href="class_f_i_x_1_1_file_store.html#o9">m_sessionFile</a> ) ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>();
00312 }
00313 } <span class="comment">//namespace FIX</span>
</pre></div><hr><address><small>

Generated on Wed Oct 30 21:17:53 2002 for QuickFIX by <a href="http://www.doxygen.org/index.html">

<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>

</a> 1.2.17 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,

 &copy;&nbsp;1997-2001</small></address>

</body>

</html>

