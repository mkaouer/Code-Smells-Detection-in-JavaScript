#!/bin/sh

if test ! -d templates; then
  echo "Error: this script should be run from the parent of the templates/ directory." 2>&1
  exit 1
fi

rm -f modelgen.mk
templates/gen > modelgen.mk
chmod -w modelgen.mk

out=bench.mk
rm -f $out
exec >$out

echo "# This file is automatically generated by bench-create, do not edit."
echo

F=50

allres=

for i in `grep /stamp: modelgen.mk | sed 's,^models/\(.*\)/stamp:.*,\1,'`; do

  Ffile=models/$i/formulae
  echo "############################## $i ##############################"
  echo
  echo "models/$i/formulae: models/$i/stamp"
  echo "	mkdir -p results"
  echo "	\$(top_builddir)/src/ltltest/randltl -F $F -u -s 0 -f 10 -r 7 \`cat models/$i/$i.ap\` > \$@"
  echo

  for ltl2tgba in -f; do
    case $i in
      *.rg) checks=e2;;
      *) checks='e4 e6 e5 e5L e5n e2 e45 e45n';;
    esac
    for check in $checks; do

      case $check in
        *L) check="${check%L} -L";;
        *n) check="${check%n} -n";;
      esac
      check="${check## } $ltl2tgba"

      resall=`echo results/$i.$check | tr -d ' ' `
      for fi in `seq 1 $F`; do
	res=`echo $resall-$fi.log | tr -d ' ' `
	echo "$res: $Ffile"
	echo "	\$(run_bench) $Ffile $fi '-$check' $i > \$@.tmp"
	echo "	mv \$@.tmp \$@"
	allres="$allres $res"
      done

      echo
    done
  done
done

echo "RESULTS =$allres"

chmod -w $out
