<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
"http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>
<TITLE>jPOS Agent Architecture Proposal</TITLE>
<META NAME="description" content="jPOS Agent Architecture Proposal">
<META NAME="keywords" content="jPOS ISO-8583">
<META NAME="author" content="Alejandro P. Revilla <apr@cs.com.uy>">
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#FFFFFF">
<div align="center">
	<img src="images/jPOS.gif"><br>
</div>
<br>

<center>
<h1><i>j</i>POS Agents</h1>
This document is a proposal for <b><i>j</i>POS's Agents</b> architecture.<br>
Feel free to comment by sending e-mail to 
<a href="mailto:jpos-dev@onelist.com">jpos-dev</a><br>
<font size="-1">
(if you are not a member you can subscribe
 <a href="mailto:jpos-dev-subscribe@onelist.com">here</a>).
</font>
</center>
<hr>

<h2>Background</h2>
<b><i>j</i>POS's Agents</b> 
is work in progress as well as this document itself.
<p>
<b><i>j</i>POS's ISO package</b> although OpenSource was
an isolated effort, now we would like to try 
Open Development for the Agents stuff so comments are
more than welcome.

<h2>Main goal</h2>

<b><i>j</i>POS's Agents</b> isolate high level applications
(such as POS or Web based stores) from acquiring institution
lower level protocols (such as -but not necessarily- ISO-8583).

<p>
Although it requires some sort of persistent storage, it
relies on higher level custom application to provide that
service (it can be anything from flat files to DBMS or OODBMS).

<p>
Most typical operations (such as purchase, refund, cancel,
cash advance, etc.) are predefined within the Agent architecture,
but <b><i>j</i>POS's Agents</b> are not limited to them.
It is a framework where custom operations (i.e. loyalty card support)
can be added with minimal impact on the whole system.

<h2>Core interfaces and classes</h2>
Core classes and interfaces are located at 
<a href="javadoc/org/jpos/core/package-summary.html">org.jpos.core</a>
package.
<br>
I'll try to describe how this classes are intended to interact by 
providing a simple example:

<h2>Sample transaction</h2>

We present here a simplified <strong>purchase</strong> operation.

<p>
<strong>Step 1:</strong>
Application creates an instance of
<a href="javadoc/org/jpos/core/CardTransaction.html">CardTransaction
</a>
and assigns a couple of well known (and possible custom) properties:

<pre>
	CardTransaction t = new GenericCardTransaction();
	Map m  = t.getMap();
	m.put (CardTransaction.OPERATION, CardTransaction.OPER_PURCHASE);
	m.put (CardTransaction.RRN, localRRN);
	m.put (CardTransaction.TERMID, localTerminalId);
	m.put (CardTransaction.CARDHOLDER, new CardHolder (pan, exp));
	m.put (CardTransaction.AMOUNT, amount);	    // BigDecimal
</pre>

<strong>Step 2:</strong>
locate suitable agent (must catch 
<a href="javadoc/org/jpos/core/CardAgentNotFoundException.html">
CardAgentNotFoundException</a>
)

<pre>
	CardAgent agent = CardAgentLookup.getAgent (t);
</pre>

<strong>Step 3:</strong>
Promote CardTransaction.
CardAgents have the chance here to promote a GenericCardTransaction 
Object into a more specialized one. Specialized CardTransactions
will probably hold 
<a href="javadoc/org/jpos/iso/ISOMsg.html">ISOMsg</a>
objects, flags, etc. and may have specific built-in functionality.

<pre>
	t = agent.promote (t);
</pre>

<strong>Step 4:</strong>
Agents are not necessarily persistent capable, they are isolated from any
particular DB implementation. There are cases where we must
reverse a transaction if the system crashes. Application
must get an image of this transaction generated by CardAgent
and save it on safe storage, just in case...

<p>
Here, a paranoid Agent, has the chance to sign and encrypt transaction images.

<pre>
	byte[] transactionImage = agent.getImage(t);
</pre>

<strong>Step 5:</strong>
Process the transaction

<pre>
	agent.process (t);
</pre>

<strong>Step 6:</strong>
If all goes fine and this is a financial transaction get a new image 
added to persistent storage along with others transactions
in the same batch.

<pre>
	byte[] transactionImage = agent.getImage(t);
</pre>


<h2>Agent design</h2>
Although not strictly necessary, reflection happens to be
a good solution for agent design. Our sample agent
<strong>DummyCardAgent</strong> uses reflection to
identify valid operations and to validate transactions
within its canHandle() function.

<p>
We introduce a few interfaces
<a href="javadoc/org/jpos/core/Sequencer.html">Sequencer</a> and
<a href="javadoc/org/jpos/core/Configuration.html">Configuration</a> 
that will be used by agents. High level application must provide 
specific implementations.

<h2>Agent licensing</h2>
OpenSource is utopic in this niche market, plagued by
trade secrets and propietary protocols. <i>j</i>POS developers 
willing to share their agents may be prevented to do so 
by financial institutions and acquirers (most protocols
are propietary).

<p>
We will try to provide as many agents as possible and
also we will try to maintain a database of not
freely available agents with pointers to their authors.

<p>Feel free to <a href="mailto:jpos@cs.com.uy">contact</a> us.
<p>--The <b><i>j</i>POS</b> Team<br>

<p><font size="-1"><center>$Id$</center></font>
</BODY>
</HTML>

